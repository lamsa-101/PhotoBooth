<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ØªØµÙˆÙŠØ± Ùˆ QR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #f8f1e4;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }

    h1 {
      color: brown;
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .intro {
      font-size: 1.5rem;
      color: #5d3a00;
      margin-bottom: 20px;
    }

    video, #preview {
      border: 5px solid brown;
      border-radius: 10px;
      transform: scaleX(-1);
      width: 100%;
      max-width: 400px;
      aspect-ratio: 3 / 4;
    }

    button {
      font-size: 1.2rem;
      margin-top: 12px;
      padding: 14px 28px;
      background-color: brown;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background-color: #8b5e3b;
      transform: scale(1.05);
    }

    #countdown {
      font-size: 32px;
      color: brown;
      margin-top: 10px;
    }

    #qrCode {
      margin-top: 20px;
      padding: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
    }

    .hidden {
      display: none !important;
    }

    #previewContainer {
      margin-top: 10px;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid brown;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #copyLink {
      display: block;
      margin: 10px auto;
      background-color: #4CAF50;
    }
  </style>
</head>
<body>
  <h1>ğŸ“¸ ØµÙˆØ± ØªØ¬Ø±Ø¨ØªÙƒ!</h1>
  <div class="intro">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø²ÙˆØ§Ø± Ø§Ù„Ù…Ù†ØªØ¯Ù‰</div>

  <video id="video" autoplay playsinline></video>
  <br />
  <button id="capture">Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©</button>
  <button onclick="startCamera()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
  <div id="countdown"></div>
  <canvas id="canvas" class="hidden"></canvas>

  <div id="previewContainer" class="hidden">
    <img id="preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
    <br />
    <button id="confirm">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¥Ø®Ø±Ø§Ø¬ QR</button>
    <button id="retry">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙˆÙŠØ±</button>
  </div>

  <div id="qrCode"></div>
  <button id="copyLink" class="hidden">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
  <div class="loader hidden" id="loader"></div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const countdownDiv = document.getElementById('countdown');
    const previewContainer = document.getElementById('previewContainer');
    const preview = document.getElementById('preview');
    const qrCodeDiv = document.getElementById('qrCode');
    const loader = document.getElementById('loader');
    const copyButton = document.getElementById('copyLink');
    let capturedBlob = null;
    let imageUrl = "";

    function hideElement(el) {
      el.classList.add('hidden');
    }

    function showElement(el) {
      el.classList.remove('hidden');
    }

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" }
        });
        video.srcObject = stream;
        showElement(video);
      } catch (err) {
        alert("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.");
      }
    }

    async function startCountdown(seconds) {
      countdownDiv.textContent = seconds;
      for (let i = seconds - 1; i >= 0; i--) {
        await new Promise(resolve => setTimeout(resolve, 1000));
        countdownDiv.textContent = i === 0 ? '' : i;
      }
    }

    function captureImage() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.save();
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      ctx.restore();

      canvas.toBlob(blob => {
        capturedBlob = blob;
        preview.src = URL.createObjectURL(blob);
        showElement(previewContainer);
        hideElement(video);
      }, 'image/png');
    }

    document.getElementById('capture').addEventListener('click', async () => {
      await startCountdown(5);
      captureImage();
    });

    document.getElementById('retry').addEventListener('click', () => {
      capturedBlob = null;
      showElement(video);
      hideElement(previewContainer);
      qrCodeDiv.innerHTML = "";
      hideElement(copyButton);
    });

    document.getElementById('confirm').addEventListener('click', () => {
      if (capturedBlob) uploadImage(capturedBlob);
    });

    copyButton.addEventListener('click', () => {
      if (imageUrl) {
        navigator.clipboard.writeText(imageUrl);
        alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©!");
      }
    });

    async function uploadImage(blob) {
      showElement(loader);
      const formData = new FormData();
      formData.append("image", blob, "image.png");

      try {
        const response = await fetch("https://api.imgbb.com/1/upload?key=95ab95a221282c26b36ba6a6a1be6887", {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        hideElement(loader);

        if (data.success) {
          imageUrl = data.data.url;
          qrCodeDiv.innerHTML = "";
          new QRCode(qrCodeDiv, { text: imageUrl, width: 128, height: 128 });
          showElement(copyButton);
        } else {
          alert("ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©.");
        }
      } catch (error) {
        hideElement(loader);
        alert("ØªØ¹Ø°Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
      }
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      startCamera();
    } else {
      alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.");
    }
  </script>
</body>
</html>
